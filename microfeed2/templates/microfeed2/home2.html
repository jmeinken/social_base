{% extends "core/base.html" %}
{% load crispy_forms_tags %}

{% block content %}

<script>
	mf2 = {}
	

	mf2.postCount = 10;
	mf2.lastPostId = 1000000;
	mf2.thread = 1;
	mf2.postIdToDelete = 0;
	
	mf2.loadFeed = function() {
		var data = {
			last_post_id: mf2.lastPostId,
			post_count: mf2.postCount,
			thread: mf2.thread
		}
		$.ajax({
			url: "/microfeed2/ajax/posts",
			type: "GET",
			dataType : "json",
			data : data
		})
		.done(function( json ) {
			$('#mf-load-more-posts-btn').replaceWith('');
			$('#mf-feed').append(json.html);
			crp.load();
			mf2.attachEvents();
			if ( json.status == 'unfinished' ) {
				mf2.lastPostId = json.lastPostId;
			} else {
				$('#mf-load-more-posts-btn').replaceWith('');
			}
				
			$('#mf-load-more-posts-btn').click(function() {
				mf2.loadFeed();
			});
		})
		.fail(function( xhr, status, errorThrown ) {
			alert( "error" );
			console.log( "Error: " + errorThrown );
			console.log( "Status: " + status );
			console.dir( xhr );
		});
	}
	
	mf2.attachEvents = function () {
		$('.mf-new-post-form').unbind().submit(function(event) {
			event.preventDefault();
			$.ajax({
				url: "/microfeed2/posts/new",
				type: "POST",
				dataType : "json",
				data : $(this).serialize()
			})
			.done(function( json ) {
				$('#mf-feed').prepend(json.html);
				$('.mf-new-post-form #id_body').val('');
				mf2.attachEvents();
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
		});
		$('.mf-edit-post-form').unbind().submit(function(event) {
			var postId = $(this).attr('data-post-id');
			event.preventDefault();
			$.ajax({
				url: "/microfeed2/posts/edit/" + postId,
				type: "POST",
				dataType : "json",
				data : $(this).serialize()
			})
			.done(function( json ) {
				$('#' + json.destinationId).html(json.html);
				crp.load();
				mf2.attachEvents();
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
		});
		$('.mf-edit-post-btn').unbind().click(function() {
			var postId = $(this).attr('data-post-id');
			$.ajax({
				url: "/microfeed2/posts/edit/" + postId,
				type: "GET",
				dataType : "json",
				data : {}
			})
			.done(function( json ) {
				$('#' + json.destinationId).html(json.html);
				crp.load();
				mf2.attachEvents();
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
			return false;
		});
		$('.mf-cancel-post-edit').unbind().click(function() {
			var postId = $(this).attr('data-post-id');
			$.ajax({
				url: "/microfeed2/posts/" + postId,
				type: "GET",
				dataType : "json",
				data : {}
			})
			.done(function( json ) {
				$('#' + json.destinationId).html(json.html);
				crp.load();
				mf2.attachEvents();
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
			return false;
		});
		$('.mf-edit-comment-btn').unbind().click(function() {
			var commentId = $(this).attr('data-comment-id');
			$('#mf-view-comment-'+commentId).hide();
			$('#mf-edit-comment-'+commentId).show();
			// ajax to load comment form
			$.ajax({
				url: "/microfeed2/ajax/comments/edit/" + commentId,
				type: "GET",
				dataType : "json",
				data: {commentId : commentId}
			})
			.done(function( json ) {
				$('#' + json.destinationId).html(json.html);
				mf2.attachEvents();
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			})
			return false;
		});
		$('.mf-cancel-comment-edit').unbind().click(function() {
			var commentId = $(this).attr('data-comment-id');
			$('#mf-edit-comment-'+commentId).hide();
			$('#mf-view-comment-'+commentId).show();
		});
		$('.mf-edit-comment-form').unbind().submit(function(event) {
			var commentId = $(this).attr('data-comment-id');
			event.preventDefault();
			$.ajax({
				url: "/microfeed2/ajax/comments/edit/" + commentId,
				type: "POST",
				dataType : "json",
				data : $(this).serialize()
			})
			.done(function( json ) {
				$('#' + json.destinationId).html(json.html);
				mf2.attachEvents();
				if (json.status == 'complete') {
					$('#mf-edit-comment-'+commentId).hide();
					$('#mf-view-comment-'+commentId).show();
				}
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
		});
		$('.mf-new-comment-form').unbind().submit(function(event) {
			var postId = $(this).attr('data-post-id');
			event.preventDefault();
			$.ajax({
				url: "/microfeed2/ajax/posts/" + postId + "/comments/new",
				type: "POST",
				dataType : "json",
				data : $(this).serialize()
			})
			.done(function( json ) {
				if ( json.status == 'complete' ) {
					$('#mf-post-comment-list-'+json.postId).append(json.html);
					$('#mf-new-comment-form-'+json.postId)[0].reset();
					mf2.attachEvents();
				}
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
		});
		$('.mf-delete-post-btn').unbind().click(function() {
			var postId = $(this).attr('data-post-id');
			mf2.postIdToDelete = postId;
			$('#mf-delete-post-modal').modal('show');
			return false;
		});
	}
	
	$(document).ready(function() {
		
		mf2.loadFeed();
		
		$('#mf-confirm-delete-post-btn').click(function() {
			$.ajax({
				url: "/microfeed2/posts/delete/" + mf2.postIdToDelete,
				type: "POST",
				dataType : "json",
				data : {dummy : 'nothing'}
			})
			.done(function( json ) {
				$('#' + json.destinationId).replaceWith(json.html);
			})
			.fail(function( xhr, status, errorThrown ) {
				alert( "error" );
				console.log( "Error: " + errorThrown );
				console.log( "Status: " + status );
				console.dir( xhr );
			});
			$('#mf-delete-post-modal').modal('hide');
		});
		
		
		
	});
	
</script>

<style>

.mf-post-block {
	background-color:white;
	padding:5px;margin:10px;
	border-radius:7px;
}

.mf-post {
	margin-bottom: 10px;
}

.mf-post-user-image {
	min-width:55px;
	float:left;
}

.mf-post-user-options {
	float:right;
}

.mf-post-meta {
	border-left: 3px solid #CCCCCC;
	margin-left: 55px;
	padding: 3px 0 5px 10px;
}

.mf-post-body {
	margin-top: 5px;
	clear: both;
}

.mf-post-media {
	margin:10px -5px 15px -5px;
	background-color:black;
	padding:5px;
}

.mf-comment {
	border-top:1px solid #B0B0B0; 
	margin-bottom: 5px;"
}

.mf-comment-user-image {
	min-width:45px;
	float:left;
}

.mf-comment-user-options {
	float:right;
}



</style>


<div class="row">
	<div class="col-sm-6  col-sm-offset-3">
		<div class="well well-sm">
			<h3>Write a message:</h3>
			{% include 'microfeed2/blocks/new_post_form.html' %}
		</div>
		<div id="mf-feed" style="background-color: gray; padding:1px 0;"></div>
	</div>
</div>


<div class="modal" id="mf-delete-post-modal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			  	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			  	<h4 class="modal-title">Delete Post</h4>
			</div>
			<div class="modal-body">
			  	<p>Are you sure you want to delete this post?</p>
			</div>
			<div class="modal-footer">
			  	<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  	<button type="button" class="btn btn-danger" id="mf-confirm-delete-post-btn">Delete Post</button>
			</div>
		</div>
	</div>
</div>




{% include 'images/javascript_templates.html' %}
    
    
{% endblock %}